# Use an official Miniconda image as the base
FROM continuumio/miniconda3

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y git make

# Clone or pull the repository
RUN git clone https://github.com/ARKNravi/MLOps-Make-File.git .;

# Check if the environment exists; if not, create it
RUN conda env list | grep mlops-makefile || conda env create -f environment.yml

# Change the port to a safe one
CMD ["bash", "-c", "\
    source activate mlops-makefile && \
    cd /app && \
    make mlflow_server && \
    port=5000; \
    while lsof -i :$port; do \
        echo Port $port is in use. Trying the next port...; \
        port=$((port + 1)); \
    done; \
    echo Using port $port; \
    # Run MLflow UI on the available port \
    mlflow ui --backend-store-uri sqlite:///mlflow.db --host 0.0.0.0 --port $port"]
